#!/bin/bash -e

# Restore artifacts from the previous build (if they exist).
#
if [ "$(ls /tmp/artifacts/ 2>/dev/null)" ]; then
  echo "---> Restoring build artifacts..."
  cp -vr /tmp/artifacts/. /usr/local/openresty/luajit/
  rm -rf /tmp/artifacts/
fi

echo "---> Building application from source..."
pushd /tmp/src/
cp -vr /tmp/src/ /opt/app-root/wildcard-router/

# FIXME: permissions to nginx temp directories

mkdir -p /opt/app-root/wildcard-router/
# {client_body_temp,proxy_temp,fastcgi_temp,uwsgi_temp,logs}
chmod g+w /opt/app-root/wildcard-router/
# {client_body_temp,proxy_temp,fastcgi_temp,uwsgi_temp,logs}

# cleanup source
rm -rf "$(pwd)"

popd > /dev/null
